<!-- Dot Grid Background -->
<div class="app-bg"></div>

<!-- Main Generator Layout -->
<main class="generator-page">
  <div class="generator-layout">
    <!-- FORGE PANEL (Left Column) -->
    <aside class="forge-column">
      <div class="panel forge-panel">
        <!-- Panel Header -->
        <header class="panel-header">
          <div class="panel-title-row">
            <svg
              class="panel-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
              />
            </svg>
            <h2 class="panel-title">The Forge</h2>
          </div>
          <p class="panel-subtitle">Craft your next viral thread</p>
        </header>

        <!-- Form Content -->
        <div class="forge-form">
          <!-- Topic Input -->
          <div class="form-group">
            <label class="form-label" for="topic">
              Topic
              <span class="required-indicator">*</span>
            </label>
            <textarea
              id="topic"
              class="textarea"
              [class.error]="topicError()"
              placeholder="What do you want to write about?"
              rows="3"
              [ngModel]="topic()"
              (ngModelChange)="topic.set($event)"
              (blur)="onTopicBlur()"
              maxlength="1000"
            ></textarea>
            @if (topicError()) {
              <span class="form-error">{{ topicError() }}</span>
            }
            <span class="form-hint">{{ topic().trim().length }}/1000 characters</span>
          </div>

          <!-- Audience Input -->
          <div class="form-group">
            <label class="form-label" for="audience"> Audience (optional) </label>
            <input
              type="text"
              id="audience"
              class="input"
              [class.error]="audienceError()"
              placeholder="Indie hackers, founders, developers..."
              [ngModel]="audience()"
              (ngModelChange)="audience.set($event)"
              (blur)="onAudienceBlur()"
              maxlength="100"
            />
            @if (audienceError()) {
              <span class="form-error">{{ audienceError() }}</span>
            }
          </div>

          <!-- Tone Selector -->
          <div class="form-group">
            <span class="form-label" id="tone-label">Tone</span>
            <div class="tone-selector" role="radiogroup" aria-labelledby="tone-label">
              @for (tone of toneOptions; track tone.value) {
                <button
                  type="button"
                  class="tone-pill"
                  role="radio"
                  [attr.aria-checked]="selectedTone() === tone.value"
                  [class.active]="selectedTone() === tone.value"
                  (click)="selectTone(tone.value)"
                >
                  {{ tone.label }}
                </button>
              }
            </div>
          </div>

          <!-- Tweet Count Slider -->
          <div class="form-group">
            <label class="form-label" for="tweet-count">
              Thread Length
              <span class="tweet-count-badge">{{ tweetCount() }} tweets</span>
            </label>
            <div class="slider-container">
              <span class="slider-label">Short</span>
              <input
                type="range"
                id="tweet-count"
                min="5"
                max="12"
                step="1"
                [ngModel]="tweetCount()"
                (ngModelChange)="tweetCount.set($event)"
              />
              <span class="slider-label">Long</span>
            </div>
            <div class="slider-ticks">
              @for (n of [5, 6, 7, 8, 9, 10, 11, 12]; track n) {
                <span class="tick" [class.active]="tweetCount() === n">
                  {{ n }}
                </span>
              }
            </div>
          </div>

          <!-- Generate Button -->
          <button
            type="button"
            class="button-primary generate-button"
            [disabled]="!isFormValid() || isGenerating()"
            [attr.aria-busy]="isGenerating()"
            (click)="onGenerate()"
          >
            <svg
              *ngIf="!isGenerating()"
              class="button-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
            </svg>
            <div *ngIf="isGenerating()" class="button-spinner" aria-hidden="true"></div>
            {{ isGenerating() ? 'Generating...' : 'Generate' }}
          </button>

          <!-- Advanced Options Toggle -->
          <button
            type="button"
            class="advanced-toggle"
            (click)="toggleAdvancedOptions()"
          >
            <svg
              class="toggle-icon"
              [class.rotated]="showAdvancedOptions()"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="6 9 12 15 18 9" />
            </svg>
            {{ showAdvancedOptions() ? 'Hide Advanced Options' : 'Show Advanced Options' }}
          </button>

          <!-- Advanced Options Section -->
          @if (showAdvancedOptions()) {
            <div class="advanced-options">
              <!-- Brand Guidelines -->
              <app-brand-guidelines
                [value]="brandGuidelines()"
                [error]="brandGuidelinesError()"
                [maxLength]="1500"
                (valueChange)="brandGuidelines.set($event)"
              ></app-brand-guidelines>

              <!-- Example Threads -->
              <div class="form-group">
                <label class="form-label">
                  Example Threads
                  <span class="form-hint-inline">(for style matching)</span>
                </label>
                @for (example of exampleThreads(); track $index) {
                  <div class="example-thread-item">
                    <textarea
                      class="textarea example-textarea"
                      [class.error]="getExampleThreadError($index)"
                      placeholder="Paste a full example thread..."
                      rows="3"
                      [ngModel]="example"
                      (ngModelChange)="updateExampleThread($index, $event)"
                      maxlength="5100"
                    ></textarea>
                    <button
                      type="button"
                      class="remove-example-btn"
                      (click)="removeExampleThread($index)"
                      title="Remove example"
                    >
                      Ã—
                    </button>
                    @if (getExampleThreadError($index)) {
                      <span class="form-error">{{ getExampleThreadError($index) }}</span>
                    }
                    <span class="form-hint">{{ example.length }}/5000 characters</span>
                  </div>
                }
                @if (canAddExampleThread()) {
                  <button
                    type="button"
                    class="add-example-btn"
                    (click)="addExampleThread()"
                  >
                    + Add Example Thread
                  </button>
                }
                @if (!canAddExampleThread()) {
                  <span class="form-hint">Maximum 3 examples reached</span>
                }
              </div>

              <!-- Style Preferences -->
              <div class="style-preferences">
                <span class="form-label">Style Preferences</span>

                <div class="style-grid">
                  <!-- Emojis Toggle -->
                  <div class="style-item">
                    <span class="style-label">Emojis</span>
                    <button
                      type="button"
                      class="tri-toggle"
                      (click)="cycleEmojis()"
                    >
                      {{ getEmojiLabel() }}
                    </button>
                  </div>

                  <!-- Numbering Toggle -->
                  <div class="style-item">
                    <span class="style-label">Numbering</span>
                    <button
                      type="button"
                      class="tri-toggle"
                      (click)="cycleNumbering()"
                    >
                      {{ getNumberingLabel() }}
                    </button>
                  </div>

                  <!-- Max Chars -->
                  <div class="style-item">
                    <span class="style-label">Max Chars</span>
                    <input
                      type="number"
                      class="chars-input"
                      [class.error]="maxCharsError()"
                      min="200"
                      max="280"
                      [ngModel]="maxCharsPerTweet()"
                      (ngModelChange)="maxCharsPerTweet.set($event)"
                    />
                  </div>

                  <!-- Hook Style -->
                  <div class="style-item">
                    <span class="style-label">Hook Style</span>
                    <select
                      class="style-select"
                      [ngModel]="hookStrength()"
                      (ngModelChange)="hookStrength.set($event)"
                    >
                      @for (option of hookOptions; track option.value) {
                        <option [ngValue]="option.value">{{ option.label }}</option>
                      }
                    </select>
                  </div>

                  <!-- CTA Type -->
                  <div class="style-item">
                    <span class="style-label">CTA Type</span>
                    <select
                      class="style-select"
                      [ngModel]="ctaType()"
                      (ngModelChange)="ctaType.set($event)"
                    >
                      @for (option of ctaOptions; track option.value) {
                        <option [ngValue]="option.value">{{ option.label }}</option>
                      }
                    </select>
                  </div>
                </div>

                @if (maxCharsError()) {
                  <span class="form-error">{{ maxCharsError() }}</span>
                }
              </div>

              <!-- Clear Advanced Options -->
              <button
                type="button"
                class="clear-advanced-btn"
                (click)="clearAdvancedOptions()"
              >
                Clear Advanced Options
              </button>
            </div>
          }

          <!-- Regenerate Section (visible when thread exists) -->
          @if (generatedThread()) {
            <button
              type="button"
              class="regenerate-button"
              [disabled]="isGenerating()"
              (click)="onRegenerate()"
            >
              <svg
                class="button-icon-sm"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10" />
                <polyline points="1 20 1 14 7 14" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
              </svg>
              Regenerate
            </button>

            <!-- Feedback Section with Suggestions -->
            <div class="feedback-section">
              <button type="button" class="feedback-toggle" (click)="toggleFeedback()">
                {{ showFeedback() ? 'âˆ’ Hide feedback' : '+ Add feedback for regeneration' }}
              </button>

              @if (showFeedback()) {
                <!-- Quick Suggestion Chips -->
                <div class="feedback-suggestions">
                  <span class="suggestions-label">Quick suggestions:</span>
                  <div class="suggestion-chips">
                    @for (suggestion of feedbackSuggestions; track suggestion) {
                      <button
                        type="button"
                        class="suggestion-chip"
                        [class.active]="feedback().toLowerCase().includes(suggestion.toLowerCase())"
                        (click)="addFeedbackSuggestion(suggestion)"
                      >
                        {{ suggestion }}
                      </button>
                    }
                  </div>
                </div>

                <input
                  type="text"
                  class="feedback-input"
                  [class.error]="feedbackError()"
                  placeholder="Or type custom feedback..."
                  [ngModel]="feedback()"
                  (ngModelChange)="feedback.set($event)"
                  (keydown)="onFeedbackKeydown($event)"
                  maxlength="1100"
                />
                @if (feedbackError()) {
                  <span class="form-error">{{ feedbackError() }}</span>
                }
                <span class="form-hint feedback-hint"
                  >{{ feedback().trim().length }}/1000 characters Â· Press Enter to regenerate</span
                >
              }
            </div>

            <!-- Quality Scores -->
            @if (threadQuality()) {
              <div class="quality-section">
                <span class="quality-label">Thread Quality</span>
                <div class="quality-scores">
                  <div class="quality-score" [class]="getQualityColor(threadQuality()!.hookScore)">
                    <span class="score-label">Hook</span>
                    <span class="score-value">{{ threadQuality()!.hookScore }}</span>
                  </div>
                  <div class="quality-score" [class]="getQualityColor(threadQuality()!.ctaScore)">
                    <span class="score-label">CTA</span>
                    <span class="score-value">{{ threadQuality()!.ctaScore }}</span>
                  </div>
                  <div class="quality-score" [class]="getQualityColor(threadQuality()!.overallScore)">
                    <span class="score-label">Overall</span>
                    <span class="score-value">{{ threadQuality()!.overallScore }}</span>
                  </div>
                </div>
                @if (threadQuality()!.warnings.length > 0) {
                  <div class="quality-warnings">
                    @for (warning of threadQuality()!.warnings; track warning) {
                      <span class="quality-warning">âš  {{ warning }}</span>
                    }
                  </div>
                }
                @if (threadQuality()!.suggestions.length > 0) {
                  <div class="quality-suggestions">
                    @for (suggestion of threadQuality()!.suggestions; track suggestion) {
                      <span class="quality-suggestion">ðŸ’¡ {{ suggestion }}</span>
                    }
                  </div>
                }
              </div>
            }

            <!-- Generated Hashtags -->
            @if (threadHashtags() && threadHashtags()!.length > 0) {
              <div class="hashtags-section">
                <span class="hashtags-label">Suggested Hashtags</span>
                <div class="hashtag-chips">
                  @for (tag of threadHashtags(); track tag) {
                    <span class="hashtag-chip">#{{ tag }}</span>
                  }
                </div>
              </div>
            }
          }
        </div>
      </div>

      <!-- Powered By Badge -->
      <div class="powered-by">
        <span class="powered-by-text">Powered by</span>
        <span class="powered-by-brand">xAI Grok</span>
      </div>
    </aside>

    <!-- PREVIEW PANEL (Right Column) -->
    <section class="preview-column">
      <div class="panel preview-panel">
        <!-- Panel Header -->
        <header class="panel-header">
          <div class="panel-title-row">
            <svg
              class="panel-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <line x1="3" y1="9" x2="21" y2="9" />
              <line x1="9" y1="21" x2="9" y2="9" />
            </svg>
            <h2 class="panel-title">Preview</h2>
          </div>
        </header>

        <!-- Thread Preview Component -->
        <app-thread-preview
          [tweets]="generatedThread()"
          [isGenerating]="isGenerating()"
          [regeneratingIndex]="regeneratingIndex()"
          (tweetEdited)="onTweetEdited($event)"
          (regenerateRequested)="onRegenerateRequested($event)"
        >
        </app-thread-preview>
      </div>
    </section>
  </div>
</main>
